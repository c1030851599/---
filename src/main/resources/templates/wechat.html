﻿﻿<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
	<meta charset="utf-8">
	<title>私信</title>
	<link rel="stylesheet" href="/css/amazeui.min.css" />
	<link rel="stylesheet" href="/css/main.css" />
	<link href="/css/bootstrap.css" rel="stylesheet">
</head>
<body>
<div class="box">
	<div class="wechat">

		<div class="sidestrip">
			<div class="am-dropdown" data-am-dropdown>
				<!--头像插件-->
				<!--<div class="own_head am-dropdown-toggle" style="background: url(../images/own_head.jpg)"></div>-->

				<div class="own_head am-dropdown-toggle">	<img th:src="@{/headImgUpload/}+ ${session.user.headImgName}" style="width: 40px" alt="" />></div>
				<!--<div class="own_head am-dropdown-toggle" th:style="'background: url('+@{../headImgUpload/}+ ${session.user.headImgName}+')'"></div>-->
				<div class="am-dropdown-content">
					<div class="own_head_top">
						<div class="own_head_top_text">
							<p class="own_name">[[${session.user.name}]]<img src="images/icon/head.png" alt="" /></p>
							<p class="own_numb" >账号：[[${session.user.username}]]</p>
							<p class="own_numb" id="topUsername" style="display: none">[[${session.user.username}]]</p>
							<p class="own_numb" id="myhead" style="display: none">[[@{/headImgUpload/}+ ${session.user.headImgName}]]</p>
						</div>
						<img th:src="@{/headImgUpload/}+ ${session.user.headImgName}" alt="" />
					</div>
					<div class="own_head_bottom">
						<p><span>地区:</span>[[${session.user.city}]]</p>
						<div class="own_head_bottom_img">
							<a href=""><img src="images/icon/head_1.png"/></a>
							<a href=""><img src="images/icon/head_2.png"/></a>
						</div>
					</div>
				</div>
			</div>
			<!--三图标-->
			<div class="sidestrip_icon">
				<a id="si_1" style="background: url(images/icon/head_2_1.png) no-repeat;"></a>
				<a id="si_2"></a>
				<a id="si_3"></a>
			</div>

			<!--底部扩展键-->
			<div id="doc-dropdown-justify-js">
				<div class="am-dropdown" id="doc-dropdown-js" style="position: initial;">
					<div class="sidestrip_bc am-dropdown-toggle"></div>
					<ul class="am-dropdown-content" style="">
						<li>
							<a href="#" data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">意见反馈</a>
							<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
								<div class="am-modal-dialog">
									<div class="am-modal-hd">Modal 标题
										<a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
									</div>
									<div class="am-modal-bd">
										Modal 内容。本 Modal 无法通过遮罩层关闭。
									</div>
								</div>
							</div>
						</li>

						<li><a href="#">备份与恢复</a></li>
						<li><a href="#">设置</a></li>
					</ul>
				</div>
			</div>
		</div>

		<!--聊天列表-->
		<div class="middle on">
			<div class="wx_search">
				<input type="text" placeholder="搜索"/>
				<button>+</button>
			</div>
			<div class="office_text">
				<ul class="user_list">
					<li th:class="${chatList.you.username}==${you.username}?'user_active':'' " th:each="chatList:${chatList}">
						<a th:href="@{/talk/}+${chatList.you.username}">
						<div class="user_head"><img th:src="@{/headImgUpload/}+ ${chatList.you.headImgName}"/></div>
						<div class="user_text">
							<p class="user_name">[[${chatList.you.username}]]</p>
							<p class="user_message">[[${chatList.newestMsg}]]</p>
							<!--<span id="sxMessage" class="badge" style="display: none; background-color: red">666</span>-->
						</div>
						<div class="user_time">[[${#dates.format(chatList.list.lasttimetalk,'MM-dd HH:mm')}]]</div>
								<span th:id="${chatList.you.username}+sxMessage" class="badge2" th:style="${chatList.list.sxMessage}==0?'display: none; background-color: red':'background-color: red' ">[[${chatList.list.sxMessage}]]</span>

						</a>
					</li>
				</ul>
			</div>
		</div>

		<!--好友列表-->
		<div class="middle">
			<div class="wx_search">
				<input type="text" placeholder="搜索"/>
				<button>+</button>
			</div>
			<div class="office_text">
				<ul class="friends_list">
					<li>
						<p>新的朋友</p>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/1.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">新的朋友</p>
							</div>
						</div>
					</li>
					<li>
						<p>公众号</p>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/2.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">公众号</p>
							</div>
						</div>
					</li>
					<li>
						<p>A</p>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/3.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">彭于晏丶plus</p>
							</div>
						</div>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/4.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">陈依依</p>
							</div>
						</div>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/5.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">毛毛</p>
							</div>
						</div>
					</li>
					<li>
						<p>B</p>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/6.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">苏笑言</p>
							</div>
						</div>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/7.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">往事不再提</p>
							</div>
						</div>
					</li>
					<li>
						<p>C</p>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/8.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">夏继涛</p>
							</div>
						</div>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/9.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">早安无恙</p>
							</div>
						</div>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/10.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">王鹏</p>
							</div>
						</div>
					</li>
					<li>
						<p>D</p>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/11.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">涨了潮了</p>
							</div>
						</div>
						<div class="friends_box">
							<div class="user_head"><img src="images/head/12.jpg"/></div>
							<div class="friends_text">
								<p class="user_name">Ktz丶中融资</p>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</div>

		<!--程序列表-->
		<div class="middle">
			<div class="wx_search">
				<input type="text" placeholder="搜索收藏内容"/>
				<button>+</button>
			</div>
		</div>

		<!--聊天窗口-->
		<div class="talk_window">
			<div class="windows_top">
				<div class="windows_top_box">
					<span id="you">[[${you.username}]]</span>
					<span id="youPic" style="display: none">[[@{/headImgUpload/}+${you.headImgName}]]</span>
					<div id="sessionid" style="display: none">[[${sessionid}]]</div>
					<div class="extend"  data-am-offcanvas="{target: '#doc-oc-demo3'}"></div>
					<!-- 侧边栏内容 -->
					<div id="doc-oc-demo3" class="am-offcanvas">
						<div class="am-offcanvas-bar am-offcanvas-bar-flip">
							<div class="am-offcanvas-content">
								<p><a href="http://music.163.com/#/song?id=385554" target="_blank">网易音乐</a></p>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!--聊天内容-->
			<div class="windows_body" >
				<div class="office_text" style="height: 100%;" id="haha">
					<ul class="content" id="chatbox">
						<li th:class="${list.me.username}==${session.user.username}?'me':'other'" th:each="list:${chatLog}"><img th:src="@{/headImgUpload/}+ ${list.me.headImgName}" title="张文超"><span style="font-size: 14px">[[${list.chatrecord.contant}]]</span></li>
					</ul>
				</div>
			</div>

			<div class="windows_input" id="talkbox">
				<div class="input_icon">
					<a href="javascript:;"></a>
				</div>
				<div class="input_box">
					<textarea name="" rows="" cols="" id="input_box"></textarea>
					<button id="send" onclick="send()" style="font-size: 14px">发送(S)</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/amazeui.min.js"></script>
<script type="text/javascript" src="js/zUI.js"></script>
<script type="text/javascript" src="js/wechat.js"></script>

<script type="text/javascript">

  $(document).ready(function() {
    var a = $("#haha")[0].scrollHeight;
    $("#haha").scrollTop(a);
  });


  var websocket = null;
  var username = $('#topUsername').text();
  //判断当前浏览器是否支持WebSocket
  if('WebSocket' in window){
    websocket = new WebSocket('ws://localhost:8000/socket/weChat/'+username);
  } else {
    alert('当前浏览器 Not support websocket');
  }

  //连接发生错误的回调方法
  websocket.onerror = function () {
    // setMessageInnerHTML('WebSocket连接发生错误');
  };

  //连接成功建立的回调方法
  websocket.onopen = function () {
    // setMessageInnerHTML('');
  };

  //接收到消息的回调方法
  websocket.onmessage = function (event) {
    setMessageInnerHTML(event.data);
  };

  //连接关闭的回调方法
  websocket.onclose = function () {
    // setMessageInnerHTML('WebSocket连接关闭');
  };

  //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
  window.onbeforeunload = function () {
    closeWebSocket();
  };

  //将消息显示在网页上
  function setMessageInnerHTML(innerHTML) {
    var text = document.getElementById('input_box');
    var chat = document.getElementById('chatbox');
    var youPic =  $("#youPic").text();
    var you =  $("#you").text();
    var arr = innerHTML.split("|");
    var username = arr[0];
    var messageId = username + "sxMessage";
    if (arr[2] !== "0" && !isNaN(arr[2])) {
      $(document.getElementById(messageId)).text(arr[2]);
      $(document.getElementById(messageId)).css("display","")
    };
    if(you == username){
      chat.innerHTML += '<li class="other"><img src="'+youPic+'"><span style="font-size: 14px">'+arr[1]+'</span></li>';
      text.value = '';
      chat.scrollTop=chat.scrollHeight;
      var a = $("#haha")[0].scrollHeight;
      $("#haha").scrollTop(a);
		}
  }

  //关闭WebSocket连接
  function closeWebSocket() {
    websocket.close();
  }

  //发送消息
  function send() {
    var messages = document.getElementById('input_box').value;
    websocket.send(messages);
  }


  //三图标
  window.onload=function(){
    function a(){
      var si1 = document.getElementById('si_1');
      var si2 = document.getElementById('si_2');
      var si3 = document.getElementById('si_3');
      si1.onclick=function(){
        si1.style.background="url(images/icon/head_2_1.png) no-repeat"
        si2.style.background="";
        si3.style.background="";
      };
      si2.onclick=function(){
        si2.style.background="url(images/icon/head_3_1.png) no-repeat"
        si1.style.background="";
        si3.style.background="";
      };
      si3.onclick=function(){
        si3.style.background="url(images/icon/head_4_1.png) no-repeat"
        si1.style.background="";
        si2.style.background="";
      };
    };
    function b(){
      var text = document.getElementById('input_box');
      var chat = document.getElementById('chatbox');
      var btn = document.getElementById('send');
      var talk = document.getElementById('talkbox');
      var you = document.getElementById('you');
      btn.onclick=function(){
        if(text.value ==''){
          alert('不能发送空消息');
        }else{

          var messages =text.value;
          var youUsername = $("#you").text();
          var session = $("#sessionid").text();
          var myheadPic = $("#myhead").text();
          $.get('/talk',{username:youUsername,messages:messages,sessionid:session},function (data){

          });
          chat.innerHTML += '<li class="me"><img src="'+myheadPic+'"><span style="font-size: 14px">'+text.value+'</span></li>';
          text.value = '';
          chat.scrollTop=chat.scrollHeight;
          var a = $("#haha")[0].scrollHeight;
          $("#haha").scrollTop(chat.scrollHeight);
          talk.style.background="#fff";
          text.style.background="#fff";

        };
      };
    };
    a();
    b();
  };
</script>
</body>

<!--webSocket 进行信息通知 -->
<script type="text/javascript">

</script>

</html>
